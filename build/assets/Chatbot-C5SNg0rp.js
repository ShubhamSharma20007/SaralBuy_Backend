import{d as yt,V as bt,n as It,R as _e,j as e,W as it,Y as dt,Z as Je,_ as Ke,B as fe,r as h,U as Qe,t as G,$ as vt,g as ct,a0 as ie,a1 as De,a2 as jt,a3 as Nt,a4 as wt,a5 as Ct,a6 as St,a7 as Dt,b as He}from"./index-nRz7PDd4.js";import{A as ut,a as mt,b as ft}from"./avatar-CCyh8JC8.js";import{f as _t}from"./fallBackName-CJO8Y_N6.js";import{A as kt,a as Mt,b as Tt,c as Rt,C as At,d as Ut,e as Lt,f as Pt,g as Bt}from"./alert-dialog-DvHQnZ2k.js";import{m as Ft}from"./mergeName-Dsr0uQzc.js";import{P as Ye}from"./paperclip-Bd-cXF6K.js";import"./index-3zwKqybI.js";/**
 * @license lucide-react v0.540.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Et=[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]],Ot=yt("send",Et);var Oe={},ot;function Vt(){if(ot)return Oe;ot=1,Object.defineProperty(Oe,"__esModule",{value:!0});var a=bt(),g=It(),f=function(){return f=Object.assign||function(r){for(var I,A=1,U=arguments.length;A<U;A++)for(var m in I=arguments[A])Object.prototype.hasOwnProperty.call(I,m)&&(r[m]=I[m]);return r},f.apply(this,arguments)};function x(r,I,A){for(var U,m=0,Y=I.length;m<Y;m++)!U&&m in I||(U||(U=Array.prototype.slice.call(I,0,m)),U[m]=I[m]);return r.concat(U||Array.prototype.slice.call(I))}function j(r){var I=r.size,A=I===void 0?25:I,U=r.SVGstrokeColor,m=U===void 0?"currentColor":U,Y=r.SVGstorkeWidth,X=Y===void 0?0:Y,J=r.SVGclassName,k=J===void 0?"star-svg":J,te=r.SVGstyle;return a.jsx("svg",f({className:k,style:te,stroke:m,fill:"currentColor",strokeWidth:X,viewBox:"0 0 24 24",width:A,height:A,xmlns:"http://www.w3.org/2000/svg"},{children:a.jsx("path",{d:"M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"})}))}function L(r,I){switch(I.type){case"PointerMove":return f(f({},r),{hoverValue:I.payload,hoverIndex:I.index});case"PointerLeave":return f(f({},r),{ratingValue:r.ratingValue,hoverIndex:0,hoverValue:null});case"MouseClick":return f(f({},r),{valueIndex:r.hoverIndex,ratingValue:I.payload});default:return r}}var c="style-module_starRatingWrap__q-lJC",O="style-module_simpleStarRating__nWUxf",d="style-module_fillIcons__6---A",P="style-module_emptyIcons__Bg-FZ",Q="style-module_tooltip__tKc3i";function p(){return typeof window<"u"&&window.matchMedia("(pointer: coarse)").matches||"ontouchstart"in window||typeof navigator<"u"&&navigator.maxTouchPoints>0}return(function(r,I){I===void 0&&(I={});var A=I.insertAt;if(typeof document<"u"){var U=document.head||document.getElementsByTagName("head")[0],m=document.createElement("style");m.type="text/css",A==="top"&&U.firstChild?U.insertBefore(m,U.firstChild):U.appendChild(m),m.styleSheet?m.styleSheet.cssText=r:m.appendChild(document.createTextNode(r))}})(".style-module_starRatingWrap__q-lJC{display:inline-block;touch-action:none}.style-module_simpleStarRating__nWUxf{display:inline-block;overflow:hidden;position:relative;touch-action:none;-webkit-user-select:none;-moz-user-select:none;user-select:none;vertical-align:middle;white-space:nowrap}.style-module_fillIcons__6---A{display:inline-block;overflow:hidden;position:absolute;top:0;white-space:nowrap}.style-module_emptyIcons__Bg-FZ{display:inline-block}.style-module_tooltip__tKc3i{background-color:#333;border-radius:5px;color:#fff;display:inline-block;padding:5px 15px;vertical-align:middle}"),Oe.Rating=function(r){var I,A,U=r.onClick,m=r.onPointerMove,Y=r.onPointerEnter,X=r.onPointerLeave,J=r.initialValue,k=J===void 0?0:J,te=r.iconsCount,z=te===void 0?5:te,ge=r.size,s=ge===void 0?40:ge,D=r.readonly,_=D!==void 0&&D,T=r.rtl,l=T!==void 0&&T,N=r.customIcons,t=N===void 0?[]:N,y=r.allowFraction,u=y!==void 0&&y,o=r.style,M=r.className,b=M===void 0?"react-simple-star-rating":M,v=r.transition,B=v!==void 0&&v,W=r.allowHover,V=W===void 0||W,be=r.disableFillHover,de=be!==void 0&&be,ke=r.fillIcon,Ve=ke===void 0?null:ke,he=r.fillColor,$e=he===void 0?"#ffbc0b":he,Ie=r.fillColorArray,ee=Ie===void 0?[]:Ie,ce=r.fillStyle,se=r.fillClassName,ve=se===void 0?"filled-icons":se,je=r.emptyIcon,Ne=je===void 0?null:je,re=r.emptyColor,Me=re===void 0?"#cccccc":re,qe=r.emptyStyle,Te=r.emptyClassName,Ge=Te===void 0?"empty-icons":Te,Re=r.allowTitleTag,ne=Re===void 0||Re,Ae=r.showTooltip,ze=Ae!==void 0&&Ae,Ue=r.tooltipDefaultText,Le=Ue===void 0?"Your Rate":Ue,we=r.tooltipArray,ue=we===void 0?[]:we,We=r.tooltipStyle,Pe=r.tooltipClassName,Be=Pe===void 0?"react-simple-star-rating-tooltip":Pe,Ce=r.SVGclassName,ae=Ce===void 0?"star-svg":Ce,i=r.titleSeparator,n=i===void 0?"out of":i,C=r.SVGstyle,$=r.SVGstorkeWidth,S=$===void 0?0:$,w=r.SVGstrokeColor,K=w===void 0?"currentColor":w,R=g.useReducer(L,{hoverIndex:0,valueIndex:0,ratingValue:k,hoverValue:null}),H=R[0],q=H.ratingValue,F=H.hoverValue,me=H.hoverIndex,pe=H.valueIndex,Fe=R[1];g.useEffect((function(){k&&Fe({type:"MouseClick",payload:0})}),[k]);var oe=g.useMemo((function(){return u?2*z:z}),[u,z]),xe=g.useMemo((function(){return k>oe?0:u||Math.floor(k)===k?Math.round(k/z*100):2*Math.ceil(k)*10}),[u,k,z,oe]),Ze=g.useMemo((function(){return(u?2*k-1:k-1)||0}),[u,k]),ye=g.useCallback((function(E){return z%2!=0?E/2/10:E*z/100}),[z]),Xe=function(E){for(var le=E.clientX,Z=E.currentTarget.children[0].getBoundingClientRect(),ht=Z.left,pt=Z.right,xt=Z.width,rt=l?pt-le:le-ht,Ee=oe,nt=Math.round(xt/oe),Se=0;Se<=oe;Se+=1)if(rt<=nt*Se){Ee=Se===0&&rt<nt?0:Se;break}var at=Ee-1;Ee>0&&(Fe({type:"PointerMove",payload:100*Ee/oe,index:at}),m&&F&&m(ye(F),at,E))},et=function(E){F&&(Fe({type:"MouseClick",payload:F}),U&&U(ye(F),me,E))},gt=g.useMemo((function(){if(V){if(de){var E=q&&q||xe;return F&&F>E?F:E}return F&&F||q&&q||xe}return q&&q||xe}),[V,de,F,q,xe]);g.useEffect((function(){ue.length>oe&&console.error("tooltipArray Array length is bigger then Icons Count length.")}),[ue.length,oe]);var tt=g.useCallback((function(E){return F&&E[me]||q&&E[pe]||k&&E[Ze]}),[F,me,q,pe,k,Ze]),st=g.useMemo((function(){return F&&ye(F)||q&&ye(q)||k&&ye(xe)}),[F,ye,q,k,xe]);return a.jsxs("span",f({className:c,style:{direction:"".concat(l?"rtl":"ltr")}},{children:[a.jsxs("span",f({className:"".concat(O," ").concat(b),style:f({cursor:_?"":"pointer"},o),onPointerMove:_?void 0:Xe,onPointerEnter:_?void 0:function(E){Y&&Y(E),p()&&Xe(E)},onPointerLeave:_?void 0:function(E){p()&&et(),Fe({type:"PointerLeave"}),X&&X(E)},onClick:_?void 0:et,"aria-hidden":"true"},{children:[a.jsx("span",f({className:"".concat(P," ").concat(Ge),style:f({color:Me},qe)},{children:x([],Array(z)).map((function(E,le){var Z;return a.jsx(g.Fragment,{children:((Z=t[le])===null||Z===void 0?void 0:Z.icon)||Ne||a.jsx(j,{SVGclassName:ae,SVGstyle:C,SVGstorkeWidth:S,SVGstrokeColor:K,size:s})},le)}))})),a.jsx("span",f({className:"".concat(d," ").concat(ve),style:f((I={},I[l?"right":"left"]=0,I.color=tt(ee)||$e,I.transition=B?"width .2s ease, color .2s ease":"",I.width="".concat(gt,"%"),I),ce),title:ne?"".concat(st," ").concat(n," ").concat(z):void 0},{children:x([],Array(z)).map((function(E,le){var Z;return a.jsx(g.Fragment,{children:((Z=t[le])===null||Z===void 0?void 0:Z.icon)||Ve||a.jsx(j,{SVGclassName:ae,SVGstyle:C,SVGstorkeWidth:S,SVGstrokeColor:K,size:s})},le)}))}))]})),ze&&a.jsx("span",f({className:"".concat(Q," ").concat(Be),style:f((A={},A[l?"marginRight":"marginLeft"]=20,A),We)},{children:(ue.length>0?tt(ue):st)||Le}))]}))},Oe}var $t=Vt();const qt=({open:a,setOpen:g,chatId:f,onSubmit:x,loading:j})=>{const[L,c]=_e.useState(0);_e.useEffect(()=>{console.log("RatingPopup: chatId prop:",f)},[f]);const O=P=>{c(P)},d=P=>{P.preventDefault(),console.log("Submit clicked, selectedRating:",L,"chatId:",f),L!==null&&x&&x(f,L)};return e.jsx(it,{open:a,onOpenChange:g,children:e.jsx(dt,{className:"w-4xs",children:e.jsxs("form",{className:"p-3 max-w-md inline-block space-y-5 ",onSubmit:d,children:[e.jsxs("div",{className:"space-y-2 grid",children:[e.jsx(Je,{className:"text-gray-800 text-3xl font-extrabold text-center",children:"Rating"}),e.jsx(Je,{className:"text-2xl text-gray-700 text-center",children:"How many stars would you give the user?"}),e.jsx(Ke,{className:"text-md text-gray-600 text-center",children:"Please rate your experience with this user. Your feedback helps us maintain a safe and trustworthy community for everyone."})]}),e.jsxs("div",{className:"space-y-5 w-full",children:[e.jsx("div",{className:"flex justify-center items-center",children:e.jsx($t.Rating,{onClick:O,initialValue:0,size:40,allowFraction:!1,className:"flex flex-nowrap",SVGclassName:"inline-block"})}),e.jsx("div",{className:"flex justify-center",children:e.jsx(fe,{type:"submit",className:"bg-orange-500 text-white px-6 py-2 rounded font-semibold disabled:opacity-50",disabled:j||L===null,children:j?"Submitting...":"Submit"})})]})]})})})},Gt=({open:a,setOpen:g,dealId:f,budget:x,partnerName:j,onAction:L,loading:c})=>{const O=d=>{L&&L(f,d)};return e.jsx(it,{open:a,onOpenChange:g,children:e.jsx(dt,{className:"w-4xs",children:e.jsxs("div",{className:"p-3 max-w-md inline-block space-y-5",children:[e.jsxs("div",{className:"space-y-2 grid",children:[e.jsx(Je,{className:"text-gray-800 text-3xl font-extrabold text-center",children:"Approved Deal"}),e.jsxs(Ke,{className:"text-md text-gray-600 text-center",children:[e.jsx("span",{className:"font-semibold",children:j})," has requested to close the deal at ",e.jsxs("span",{className:"font-bold text-orange-600",children:["₹",x]}),"."]}),e.jsx(Ke,{className:"text-sm text-gray-500 text-center",children:"Do you want to complete this deal or reject the request?"})]}),e.jsx("div",{className:"space-y-5 w-full",children:e.jsxs("div",{className:"flex justify-center gap-4",children:[e.jsx(fe,{variant:"outline",className:"border-red-500 text-red-500 hover:bg-red-50 px-6 py-2 rounded font-semibold disabled:opacity-50",onClick:()=>O("reject"),disabled:c,children:c?"Processing...":"Reject Deal"}),e.jsx(fe,{className:"bg-orange-600 cursor-pointer hover:bg-orange-700 text-white px-6 py-2 rounded font-semibold disabled:opacity-50",onClick:()=>O("accept"),disabled:c,children:c?"Processing...":"Complete Deal"})]})})]})})})},zt=({open:a,setOpen:g,onConfirm:f,loading:x})=>{const[j,L]=h.useState(""),c=()=>{const d=Number(j);if(!j||isNaN(d)||d<=0){G.error("Please enter a valid budget amount");return}f(d),L("")},O=()=>{L(""),g(!1)};return e.jsx(kt,{open:a,onOpenChange:g,children:e.jsxs(Mt,{children:[e.jsxs(Tt,{children:[e.jsxs(Rt,{className:"flex gap-3",children:[e.jsx("div",{className:"bg-orange-100 rounded-full p-1",children:e.jsx(At,{className:"text-yellow-500"})}),"Close Deal"]}),e.jsx(Ut,{children:"Enter the agreed budget amount to close the deal"})]}),e.jsx("div",{className:"py-2",children:e.jsx(Qe,{type:"number",placeholder:"Enter budget amount",value:j,onChange:d=>{L(d.target.value)},min:"0",step:"0.01"})}),e.jsxs(Lt,{children:[e.jsx(Pt,{onClick:O,className:"cursor-pointer",children:"Cancel"}),e.jsx(Bt,{disabled:x,onClick:c,className:"bg-orange-600 cursor-pointer hover:bg-orange-700 text-white px-6 py-2 rounded font-semibold disabled:opacity-50",children:x?"Closing...":"Confirm & Close Deal"})]})]})})},lt=({onSelectContact:a,contacts:g,selectedContactId:f,currentUserId:x})=>{const[j,L]=h.useState(""),{isUserOnline:c}=ie(),O=g.filter(d=>d&&d.name&&d.name.toLowerCase().includes(j.toLowerCase())).sort((d,P)=>{const Q=d.lastMessage?.timestamp?new Date(d.lastMessage.timestamp).getTime():0;return(P.lastMessage?.timestamp?new Date(P.lastMessage.timestamp).getTime():0)-Q});return e.jsxs("div",{className:"h-full flex flex-col bg-chat-sidebar border-r-0 border-chat-border",children:[e.jsxs("div",{className:"p-4 border-b border-chat-border",children:[e.jsx("h2",{className:"text-lg font-semibold mb-2 text-gray-600",children:"Messaging"}),e.jsxs("div",{className:"relative",children:[e.jsx(St,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground h-4 w-4"}),e.jsx(Qe,{placeholder:"Search in dashboard...",value:j,onChange:d=>L(d.target.value),className:"pl-10 bg-background border-chat-border"})]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:O.length===0?e.jsx("div",{className:"p-4 text-center text-muted-foreground",children:e.jsx("p",{children:"No Contact Found"})}):O.map(d=>{const P=d.buyerId===x?d.buyerUnreadCount||0:d.sellerUnreadCount||0,Q=d.roomId===f,p=d.userType==="buyer"?d.sellerId:d.buyerId,r=c(p);return e.jsx("div",{onClick:()=>{Q||a(d)},className:`px-2 py-1 border-chat-border hover:bg-chat-message-bg cursor-pointer transition-colors ${Q?"bg-orange-50":""}`,children:e.jsxs("div",{className:`flex items-start space-x-3 bg-white p-3 rounded-md ${Q?"border-2 border-orange-500":""}`,children:[e.jsxs("div",{className:"relative",children:[e.jsxs(ut,{className:"h-12 w-12",children:[e.jsx(mt,{src:d.avatar,alt:d.name}),e.jsx(ft,{children:_t(d.name)})]}),r?e.jsx("div",{className:"absolute -bottom-1 -right-1 w-4 h-4 bg-green-500 border-2 border-white rounded-full"}):e.jsx("div",{className:"absolute -bottom-1 -right-1 w-4 h-4 bg-red-500 border-2 border-white rounded-full"})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsx("div",{className:"flex flex-col",children:e.jsx("h3",{className:"font-semibold text-gray-600 truncate",children:d.name})}),e.jsxs("div",{className:"flex flex-col items-end gap-1",children:[e.jsx("span",{className:"text-xs text-muted-foreground ml-2",children:d.lastMessage&&d.lastMessage.timestamp?new Date(d.lastMessage.timestamp).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!0}):""}),d.chatrating>0&&e.jsxs("div",{className:"flex items-center text-yellow-500",children:[e.jsx(Dt,{className:"w-3 h-3 mr-1 fill-yellow-500"}),e.jsx("span",{className:"text-xs font-medium",children:d.chatrating})]})]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("p",{className:"text-[13px] text-muted-foreground font-medium truncate mt-1",children:d.lastMessage&&d.lastMessage.message?d.lastMessage.message:"No messages yet"}),!Q&&P>0&&e.jsx("span",{className:"ml-2 bg-orange-500 text-white rounded-full px-2 py-0.5 text-xs font-semibold",children:P})]})]})]})},d.roomId)})})]})},Wt=({selectedContact:a,userType:g,userId:f,currentUserId:x,productId:j,buyerId:L,sellerId:c,messages:O,setMessages:d,onSidebarContactUpdate:P,setSelectedContact:Q,isOnline:p,mergeQuoteMessage:r})=>{const I=h.useRef(null),[A,U]=h.useState(""),[m]=h.useState(()=>De.getInstance()),[Y,X]=h.useState(!1),[J,k]=h.useState(!1),[te,z]=h.useState(null),[ge,s]=h.useState(!1),[D,_]=h.useState(!1),[T,l]=h.useState(!1),{user:N}=ct(),[t,y]=h.useState(null),u=h.useRef(new Set),[o,M]=h.useState(null),[b,v]=h.useState(null),[B,W]=h.useState(!1),[V,be]=h.useState(null),de=_e.useRef(null),ke=()=>{I.current&&I.current.scrollTo({top:I.current.scrollHeight,behavior:"smooth"})};h.useEffect(()=>{const i=a?.productId||j,n=a?.sellerId||c,C=a?.buyerId||L;if(!i||!n||!g||!C){console.error("Missing required parameters:",{actualProductId:i,actualSellerId:n,actualBuyerId:C,userType:g});return}m.joinRoom(x,i,n,g,C),m.getChatHistory(i,n,C,S=>{if(S&&Array.isArray(S.messages)){const w=S.messages.map((R,H)=>({id:R._id||H+"_"+(R.timestamp||""),text:R.message,senderId:R.senderId,senderType:R.senderType,time:R.timestamp?new Date(R.timestamp).toLocaleTimeString():"",attachment:R.attachment||null,timestamp:R.timestamp}));console.log(w,324),d(w);const K=a?.roomId||m.generateRoomId(i,C,n);if(w.length===0&&!u.current.has(K)){u.current.add(K);const R=x||(g==="buyer"?C:n),H=new Date().toISOString();console.log("Auto-sending initial greeting for new chat:",K);const q=N?Ft(N):g==="buyer"?"Buyer":"Seller",F=r||`Hi this side ${q}. How i can help you?`,me={id:Date.now().toString(),text:F,senderId:R,senderType:g,time:new Date().toLocaleTimeString(),timestamp:H,isOptimistic:!0,attachment:null};d([me]),typeof P=="function"&&a&&P(a.roomId,pe=>({...pe,lastMessage:{message:F,timestamp:H,senderId:R,senderType:g},buyerUnreadCount:g==="buyer"?0:pe.buyerUnreadCount,sellerUnreadCount:g==="seller"?0:pe.sellerUnreadCount})),setTimeout(()=>{m.sendMessage(i,n,F,R,g,C,void 0)},100)}setTimeout(()=>ke(),100),w.length>0&&typeof P=="function"&&a&&P(a.roomId,R=>({...R,lastMessage:S.lastMessage,buyerUnreadCount:S.buyerUnreadCount||0,sellerUnreadCount:S.sellerUnreadCount||0}))}});const $=S=>{S&&a&&S.roomId===a.roomId&&typeof P=="function"&&P(a.roomId,w=>({...w,lastMessage:S.lastMessage,buyerUnreadCount:S.buyerUnreadCount!==void 0?S.buyerUnreadCount:w.buyerUnreadCount,sellerUnreadCount:S.sellerUnreadCount!==void 0?S.sellerUnreadCount:w.sellerUnreadCount}))};return m.socket&&m.socket.on("chat_last_message_update",$),()=>{m.socket&&m.socket.off("chat_last_message_update",$)}},[f,a,g,x]);const[Ve,he]=h.useState(!1),[$e,Ie]=h.useState(!1),[ee,ce]=h.useState(!1),[se,ve]=h.useState(!1),[je,Ne]=h.useState(!1),[re,Me]=h.useState(!1),[qe,Te]=h.useState(null),[Ge,Re]=h.useState(0),ne=async()=>{const i=a?.productId||j;if(!i){k(!1),ce(!1);return}try{const n=await He.checkClosedDeal({productId:i,sellerId:a?.sellerId||c,buyerId:a?.buyerId||L});console.log("checkDealStatus response:",n),n&&n.exists?(k(!0),Te(n.closedDeal?._id),n.closedDeal?.closedDealStatus==="waiting_seller_approval"?(ce(!0),Re(n.closedDeal?.finalBudget||0)):n.closedDeal?.closedDealStatus==="rejected"?(ce(!1),Me(!0),k(!1)):(ce(!1),Me(!1)),n.userRole?.isSeller?(ve(!0),Ne(!1)):n.userRole?.isBuyer?(ve(!1),Ne(!0)):(ve(!1),Ne(!1))):(k(!1),ce(!1))}catch(n){console.error("Error fetching requirement status:",n)}},Ae=async(i,n)=>{Ie(!0);try{await He.respondToCloseDeal({dealId:i,action:n}),G.success(`Deal ${n}ed successfully`),he(!1),await ne(),n==="accept"&&(y(a._id),_(!0))}catch(C){G.error(C.message||"Failed to respond to deal")}finally{Ie(!1)}};h.useEffect(()=>{const i=C=>{console.log("ChatArea received close_deal_resolution:",C);const{action:$,message:S}=C;G.info(S||`Deal was ${$}ed`),ne()},n=C=>{console.log("ChatArea received close_deal_request:",C),G.info("Buyer requested to close the deal"),ne()};return m.socket&&(m.socket.on("close_deal_resolution",i),m.socket.on("close_deal_request",n)),()=>{m.socket&&(m.socket.off("close_deal_resolution",i),m.socket.off("close_deal_request",n))}},[ne]),h.useEffect(()=>{ne()},[a,j]),h.useEffect(()=>{a?.isDealClosed&&k(!0)},[a?.isDealClosed]);const ze=i=>{const n=i.target.files?.[0];if(!n)return;const C=10*1024*1024;if(n.size>C){G.error("File size exceeds 10MB limit");return}if(!["image/jpeg","image/png","image/webp","image/gif","image/heic","image/tiff","image/bmp","image/avif","application/pdf","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","text/plain","text/csv","application/vnd.ms-powerpoint","application/vnd.openxmlformats-officedocument.presentationml.presentation"].includes(n.type)){G.error("Invalid file type. Only images and documents are allowed.");return}if(M(n),n.type.startsWith("image/")){const S=new FileReader;S.onload=w=>{v(w.target?.result)},S.readAsDataURL(n)}else v(null);Ue(n)},Ue=i=>{W(!0),m.uploadAttachment(i,n=>{be(n),W(!1)},n=>{W(!1),G.error(n||"Failed to upload file"),M(null),v(null)})},Le=()=>{M(null),v(null),be(null),de.current&&(de.current.value="")},we=()=>{if(!A.trim()&&!V)return;const i=a?.buyerId||L,n=a?.sellerId||c,C=a?.productId||j,$=x||(g==="buyer"?i:n);m.sendMessage(C,n,A||(V?`Sent ${V.type==="image"?"an image":"a document"}`:""),$,g,i,V||void 0);const S={id:Date.now().toString(),text:A||(V?`Sent ${V.type==="image"?"an image":"a document"}`:""),senderId:$,senderType:g,time:new Date().toLocaleTimeString(),isOptimistic:!0,attachment:V||null};d(w=>[...w,S]),U(""),Le(),typeof P=="function"&&a&&P(a.roomId,w=>({...w,lastMessage:{message:A||(V?`Sent ${V.type==="image"?"an image":"a document"}`:""),timestamp:new Date().toISOString(),senderId:$,senderType:g},buyerUnreadCount:g==="buyer"?0:w.buyerUnreadCount,sellerUnreadCount:g==="seller"?0:w.sellerUnreadCount})),setTimeout(()=>{const w=document.querySelector(".chat-messages-container");w&&(w.scrollTop=w.scrollHeight)},100)},ue=async i=>{const n=a;if(!n?.productId||!n?.sellerId||!n?.buyerId){G.error("Missing required parameters to close deal.");return}z(i),X(!0);try{await He.closeDeal({productId:n.productId,sellerId:n.sellerId,buyerId:n.buyerId,finalBudget:i}),G.success("Deal closed successfully!"),s(!1),ne(),console.log("handleCloseDeal: selectedContact (sc):",n),console.log("handleCloseDeal: sc._id:",n._id);let C=n._id;C?(y(C),_(!0)):(console.log("Chat ID missing, attempting to fetch from recent chats..."),m.getRecentChats(x,$=>{if($&&Array.isArray($.chats)){const S=$.chats.find(w=>w.roomId===n.roomId||w.product?._id===n.productId&&w.seller?._id===n.sellerId&&w.buyer?._id===n.buyerId);S?(console.log("Found chat for rating:",S),y(S._id),Q(w=>({...w,_id:S._id})),_(!0)):(console.warn("Could not find chat in recent chats after deal close."),G.error("Could not find chat data for rating."))}}))}catch{G.error("Failed to close deal.")}finally{X(!1)}},We=async()=>{const i=a;if(!i?.productId||!i?.sellerId||!i?.buyerId){G.error("Missing required parameters to close deal.");return}let n=te;if(n===null||isNaN(n)){s(!0);return}await ue(n)},Pe=async(i,n)=>{if(i){l(!0);try{await m.rateChat({chatId:i,rating:n,ratedBy:x}),G.success("Thank you for your feedback!"),_(!1),y(null),P(a.roomId,C=>({...C,chatrating:n}))}catch{G.error("Failed to submit rating.")}finally{l(!1)}}};if(!a)return e.jsx("div",{className:"flex-1 flex items-center justify-center bg-background",children:e.jsxs("div",{className:"text-center text-muted-foreground",children:[e.jsx("h3",{className:"text-lg font-medium mb-2",children:"Select a conversation"}),e.jsx("p",{className:"text-sm",children:"Choose a contact from the sidebar to start messaging"})]})});const Be=a?.buyerId||L,Ce=a?.sellerId||c,ae=x===Be&&x===Ce||Be===Ce;return e.jsxs(e.Fragment,{children:[e.jsx(zt,{open:ge,setOpen:s,onConfirm:ue,loading:Y}),e.jsxs("div",{className:"flex-1 flex flex-col border-1 rounded-md w-full min-h-0",children:[e.jsxs("div",{className:"border-b border-chat-border bg-background",children:[e.jsx("div",{className:"flex justify-between items-center space-x-2 bg-gray-100 p-2",children:e.jsxs("p",{className:"text-sm text-muted-foreground font-semibold",children:["Product Name :  ",a.productName||"Product Discussion"]})}),e.jsx("div",{className:"flex items-center space-x-3 p-3 bg-orange-50",children:e.jsx("div",{className:"flex justify-between items-center w-full",children:e.jsxs("div",{className:"relative flex items-center gap-3 justify-between w-full ",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(ut,{className:"h-10 w-10",children:[e.jsx(mt,{src:a.avatar,alt:a.name}),e.jsx(ft,{children:a.name.charAt(0)})]}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("h3",{className:"font-semibold text-gray-700",children:a.name}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:`h-2 w-2 rounded-full ${p?"bg-green-600":"bg-red-600"}`}),e.jsx("span",{className:`text-sm font-medium ${p?"text-green-600":"text-red-600"}`,children:p?"Online":"Offline"})]})]})]}),e.jsx("div",{children:e.jsx("div",{className:"flex items-center gap-3 ",children:(g==="buyer"||J||re)&&e.jsx(fe,{variant:ee&&se?"default":re?"destructive":"outline",size:"sm",className:`${ee&&se||ee&&je?"bg-orange-600 hover:bg-orange-700 text-white border-orange-600":re?"bg-red-100 text-red-600 border-red-200 hover:bg-red-100 cursor-not-allowed":"text-orange-600 hover:text-orange-600 bg-transparent cursor-pointer hover:bg-transparent border-orange-600"} w-24 sm:w-auto px-4 text-sm font-medium cursor-pointer`,onClick:ee&&se?()=>he(!0):We,disabled:Y||J&&!(ee&&se)||O.length===0||re,children:Y?"Closing...":ee&&se?"Closed deal request":ee&&je?"Deal in Progress":re?"Deal Rejected":J?"Deal Closed":"Close Deal"})})})]})})})]}),e.jsx("div",{ref:I,className:"flex-1 overflow-y-auto p-4 space-y-6 chat-messages-container",children:ae?e.jsx("div",{className:"text-center text-red-500 font-semibold",children:"Cannot sent messages to yourself. Buyer and seller must be different users."}):O.map((i,n)=>{const C=i.senderId===f&&i.senderType===g,$=w=>{const K=new Date(w),R=new Date,H=new Date(R);H.setDate(H.getDate()-1);const q=new Date(K.getFullYear(),K.getMonth(),K.getDate()),F=new Date(R.getFullYear(),R.getMonth(),R.getDate()),me=new Date(H.getFullYear(),H.getMonth(),H.getDate());return q.getTime()===F.getTime()?"Today":q.getTime()===me.getTime()?"Yesterday":K.toLocaleDateString("en-US",{month:"short",day:"numeric",year:K.getFullYear()!==R.getFullYear()?"numeric":void 0})},S=n===0||i.timestamp&&O[n-1]?.timestamp&&new Date(i.timestamp).toDateString()!==new Date(O[n-1].timestamp).toDateString();return e.jsxs(_e.Fragment,{children:[S&&(i.timestamp||i.time)&&e.jsx("div",{className:"flex items-center justify-center my-4",children:e.jsx("div",{className:"bg-gray-200 text-gray-600 text-xs px-3 py-1 rounded-full",children:i.timestamp?$(i.timestamp):$(new Date)})}),e.jsxs("div",{className:`flex flex-col ${C?"items-end":"items-start"}`,children:[e.jsxs("div",{className:`max-w-[70%] px-4 py-2 ${C?"bg-gray-500 text-white rounded-tl-lg rounded-bl-lg rounded-br-lg":"bg-gray-600 text-white rounded-tr-lg rounded-bl-lg rounded-br-lg"}`,children:[i.attachment&&i.attachment.url&&i.attachment.type&&e.jsx("div",{className:"mb-2",children:i.attachment.type==="image"?e.jsx("img",{src:i.attachment.url,alt:i.attachment.fileName,className:"max-w-full h-auto rounded-md cursor-pointer  w-32",onClick:()=>window.open(i.attachment.url,"_blank")}):e.jsxs("a",{href:i.attachment.url,target:"_blank",rel:"noopener noreferrer",className:"flex items-center gap-2 p-2 bg-white/10 rounded hover:bg-white/20 transition-colors",children:[e.jsx(Ye,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm",children:i.attachment.fileName})]})}),i.text&&e.jsx("p",{className:"text-sm",children:i.text})]}),e.jsx("span",{className:"text-xs text-muted-foreground mt-1",children:i.timestamp?e.jsx(e.Fragment,{children:new Date(i.timestamp).toLocaleTimeString("en-IN",{hour:"2-digit",minute:"2-digit",hour12:!0})}):i.time?new Date(`1970-01-01T${i.time}`).toLocaleTimeString("en-IN",{hour:"2-digit",minute:"2-digit",hour12:!0}):""})]})]},i.id)})}),e.jsxs("div",{className:"p-4 border-t border-chat-border bg-background",children:[(o||V)&&e.jsx("div",{className:"mb-3 p-3 bg-gray-50 rounded-lg border border-gray-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[b?e.jsx("img",{src:b,alt:"Preview",className:"w-16 h-16 object-cover rounded"}):e.jsx("div",{className:"w-16 h-16 bg-gray-200 rounded flex items-center justify-center",children:e.jsx(Ye,{className:"w-6 h-6 text-gray-500"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-medium text-gray-700",children:o?.name}),e.jsx("p",{className:"text-xs text-gray-500",children:o?`${(o.size/1024).toFixed(2)} KB`:""}),B&&e.jsx("p",{className:"text-xs text-orange-500",children:"Uploading..."}),V&&!B&&e.jsx("p",{className:"text-xs text-green-500",children:"Ready to send"})]})]}),e.jsx(fe,{variant:"ghost",size:"sm",onClick:Le,disabled:B,className:"text-red-500 hover:text-red-700",children:"Remove"})]})}),e.jsxs("div",{className:"flex items-center space-x-5",children:[e.jsx("div",{className:"flex-1 relative",children:e.jsx(Qe,{placeholder:"Type your message",value:A,onChange:i=>U(i.target.value),onKeyPress:i=>i.key==="Enter"&&!B&&we(),className:"h-12 px-5 bg-white rounded-full text-sm placeholder:text-muted-foreground tracking-wide focus-visible:ring-1 focus-visible:ring-orange-500 border border-gray-300",disabled:ae||B})}),e.jsx("input",{ref:de,type:"file",accept:"image/*,.pdf,.doc,.docx,.xls,.xlsx,.txt,.csv,.ppt,.pptx",onChange:ze,className:"hidden"}),e.jsx("div",{className:`p-2 rounded-full border-2 border-gray-500 ${ae||B?"opacity-50 cursor-not-allowed":"cursor-pointer hover:bg-gray-100"}`,onClick:()=>!ae&&!B&&de.current?.click(),children:e.jsx(Ye,{className:"w-4 h-4 text-gray-700"})}),e.jsx(fe,{onClick:we,size:"icon",className:"cursor-pointer w-12",disabled:ae||B||!A.trim()&&!V,children:e.jsx(Ot,{className:"h-4 w-4"})})]})]})]}),e.jsx(qt,{open:D,setOpen:_,chatId:t||a?._id||"",onSubmit:Pe,loading:T}),e.jsx(Gt,{open:Ve,setOpen:he,dealId:qe||"",budget:Ge,partnerName:a?.name||"Buyer",onAction:Ae,loading:$e})]})},es=()=>{const a=vt(),{user:g}=ct();_e.useEffect(()=>(localStorage.setItem("chatbot_active_user","true"),()=>{localStorage.removeItem("chatbot_active_user")}),[]);let f=a.state?.productId,x=a.state?.buyerId,j=a.state?.sellerId,L=a.state?.message||"";if(!f||!x||!j)try{const s=localStorage.getItem("chatIds");if(s){const D=JSON.parse(s);f=f||D.productId,x=x||D.buyerId,j=j||D.sellerId}}catch(s){console.error("Error parsing chatIds from localStorage:",s)}const c=g?._id,[O,d]=h.useState([]),[P,Q]=h.useState([]);h.useEffect(()=>{const s=ie.subscribe(D=>{d(D.recentChats||[])});return d(ie.getState().recentChats||[]),()=>{try{s()}catch{}}},[]);const[p,r]=h.useState(null),[I,A]=h.useState(!1),[U,m]=h.useState([]),[Y,X]=h.useState(!0),J=h.useRef({}),k=p?c===p.buyerId?"buyer":"seller":c===x?"buyer":"seller",te=c;h.useEffect(()=>{if(!c)return;const s=De.getInstance();s.connect(),s.getOnlineUsers(c);const D=c===x?"buyer":"seller";X(!0),s.getRecentChats(c,_=>{if(_&&Array.isArray(_.chats)){const T=_.chats.map(l=>{const N=l.product?._id||l.productId,t=l.seller?._id||l.sellerId,y=l.buyer?._id||l.buyerId;let u="Unknown",o="";return l.userType==="buyer"?(u=l.seller?.firstName&&l.seller?.lastName?`${l.seller.firstName} ${l.seller.lastName}`:l.seller?.firstName||l.seller?.lastName||"Seller",o=l.seller?.profileImage||""):l.userType==="seller"&&(u=l.buyer?.firstName&&l.buyer?.lastName?`${l.buyer.firstName} ${l.buyer.lastName}`:l.buyer?.firstName||l.buyer?.lastName||"Buyer",o=l.buyer?.profileImage||""),{_id:l._id,roomId:l.roomId,productId:N,sellerId:t,buyerId:y,name:u,avatar:o,isOnline:!0,lastMessage:l.lastMessage,messageCount:l.messageCount||0,buyerUnreadCount:l.buyerUnreadCount||0,sellerUnreadCount:l.sellerUnreadCount||0,productName:l.product?.title||"Product Discussion",userType:l.userType,chatrating:l.chatrating}});d(T);try{ie.getState().setRecentChats(T)}catch(l){console.error("Failed to set recent chats in store:",l)}if(f&&j&&x){const l=T.find(N=>N.productId===f&&N.sellerId===j&&N.buyerId===x);if(l)r(l);else{console.log("No matching recent chat, creating new conversation");let N=x,t=j;if(D==="buyer"?N=c:D==="seller"&&(t=c),N===t){console.error("Cannot create chat: buyerId and sellerId are the same!",{finalBuyerId:N,finalSellerId:t});return}const y=a.state?.partnerName,u=a.state?.partnerAvatar,o={roomId:s.generateRoomId(f,x,j),productId:f,sellerId:j,buyerId:x,name:y||(D==="buyer"?"Seller":"Buyer"),avatar:u||"",isOnline:!0,lastMessage:null,buyerUnreadCount:0,sellerUnreadCount:0,productName:"Product Discussion",userType:D};r(o)}}else T.length>0&&r(T[0])}else if(f&&j&&x){console.log("No recent chats, but IDs provided - creating new conversation");let T=x,l=j;if(D==="buyer"?T=c:D==="seller"&&(l=c),T===l){console.error("Cannot create chat: buyerId and sellerId are the same!",{finalBuyerId:T,finalSellerId:l});return}const N=a.state?.partnerName,t=a.state?.partnerAvatar,y={roomId:s.generateRoomId(f,x,j),productId:f,sellerId:j,buyerId:x,name:N||(k==="buyer"?"Seller":"Buyer"),avatar:t||"",isOnline:!0,lastMessage:null,messageCount:0,buyerUnreadCount:0,sellerUnreadCount:0,productName:"Product Discussion",userType:D};r(y)}X(!1)})},[c,f,j,x]),h.useEffect(()=>{if(!c)return;const s=De.getInstance();s.connect();const D=t=>{console.log("Received message in Chatbot:",t);let y=t.roomId;!y&&t.productId&&t.buyerId&&t.sellerId&&(y=s.generateRoomId(t.productId,t.buyerId,t.sellerId)),console.log("Processed roomId:",y),d(u=>u.map(o=>{if(o.roomId===y){let M=t.lastMessage||{message:t.message,timestamp:t.timestamp,senderId:t.senderId,senderType:t.senderType},b=typeof t.buyerUnreadCount=="number"?t.buyerUnreadCount:o.buyerUnreadCount,v=typeof t.sellerUnreadCount=="number"?t.sellerUnreadCount:o.sellerUnreadCount;return p&&y===p.roomId?c===o.buyerId?b=0:c===o.sellerId&&(v=0):t.senderType==="seller"&&c===o.buyerId?b=(o.buyerUnreadCount||0)+1:t.senderType==="buyer"&&c===o.sellerId&&(v=(o.sellerUnreadCount||0)+1),{...o,lastMessage:M,buyerUnreadCount:b,sellerUnreadCount:v}}return o})),p&&y===p.roomId?(console.log("Updating messages state for current room"),m(u=>{const o=u.findIndex(b=>b.isOptimistic&&b.text===t.message&&b.senderId===t.senderId&&b.senderType===t.senderType);if(o!==-1){const b=[...u];return b[o]={...b[o],id:t.id||b[o].id,time:t.timestamp?new Date(t.timestamp).toLocaleTimeString():b[o].time,isOptimistic:!1},b}return u.some(b=>b.id&&t.id&&b.id===t.id||b.text===t.message&&b.senderId===t.senderId&&b.time===(t.timestamp?new Date(t.timestamp).toLocaleTimeString():""))?u:[...u,{id:t.id||Date.now().toString()+Math.random(),text:t.message,senderId:t.senderId,senderType:t.senderType,time:t.timestamp?new Date(t.timestamp).toLocaleTimeString():new Date().toLocaleTimeString(),attachment:t.attachment||null}]})):console.log("Message not for current room:",{roomIdFromData:y,selectedRoomId:p?.roomId}),(!p||y!==p.roomId)&&G.info(`New message from ${t.senderType}`,{description:t.message,duration:3e3}),setTimeout(()=>{const u=document.querySelector(".chat-messages-container");u&&(u.scrollTop=u.scrollHeight)},100)},_=t=>{if(t&&t.lastMessage){let y=t.roomId;!y&&t.productId&&t.buyerId&&t.sellerId&&(y=s.generateRoomId(t.productId,t.buyerId,t.sellerId)),d(u=>u.map(o=>o.roomId===y?{...o,lastMessage:t.lastMessage}:o))}},T=t=>{console.log("Chatbot received deal_closed:",t);const{productId:y,buyerId:u,sellerId:o,closedDeal:M,finalBudget:b}=t,v=s.generateRoomId(y,u,o);d(W=>W.map(V=>V.roomId===v?{...V,isDealClosed:!0,closedDeal:M}:V));const B=M?.closedAt?new Date(M.closedAt).toLocaleString():"just now";G.success("Deal closed!",{description:`Final budget: ₹${b}. Closed at ${B}`,duration:5e3}),p&&p.roomId===v&&r(W=>({...W,isDealClosed:!0,closedDeal:M}))},l=t=>{console.log("Chatbot received recent_chat_update:",t);let y=t.roomId;if(!y&&t.productId&&t.buyerId&&t.sellerId&&(y=s.generateRoomId(t.productId,t.buyerId,t.sellerId)),p&&y===p.roomId&&t.lastMessage){if(console.log("Updating messages from recent_chat_update"),t.buyerName||t.sellerName){const o=(c===t.buyerId?"buyer":"seller")==="buyer"?t.sellerName:t.buyerName;o&&p.name!==o&&r(M=>({...M,name:o}))}m(u=>{const o=t.lastMessage,M=u.findIndex(v=>v.isOptimistic&&v.text===o.message&&v.senderId===o.senderId&&v.senderType===o.senderType);if(M!==-1){const v=[...u];return v[M]={...v[M],id:o._id||v[M].id,time:o.timestamp?new Date(o.timestamp).toLocaleTimeString():v[M].time,isOptimistic:!1},v}return u.some(v=>v.id&&o._id&&v.id===o._id||v.text===o.message&&v.senderId===o.senderId&&v.time===(o.timestamp?new Date(o.timestamp).toLocaleTimeString():""))?u:[...u,{id:o._id||Date.now().toString()+Math.random(),text:o.message,senderId:o.senderId,senderType:o.senderType,time:o.timestamp?new Date(o.timestamp).toLocaleTimeString():new Date().toLocaleTimeString(),attachment:o.attachment||null}]})}},N=t=>{console.log("Chatbot received chat_rating_notification:",t);const{chatId:y,roomId:u,rating:o,ratedBy:M,raterName:b,message:v}=t;d(B=>B.map(W=>W._id===y||W.roomId===u?{...W,chatrating:o}:W)),p&&(p._id===y||p.roomId===u)&&r(B=>({...B,chatrating:o}))};return s.socket&&(s.socket.on("receive_message",D),s.socket.on("chat_last_message_update",_),s.socket.on("recent_chat_update",l),s.socket.on("deal_closed",T),s.socket.on("chat_rating_notification",N)),()=>{s.socket&&(s.socket.off("receive_message",D),s.socket.off("chat_last_message_update",_),s.socket.off("recent_chat_update",l),s.socket.off("deal_closed",T),s.socket.off("chat_rating_notification",N))}},[c,p]),h.useEffect(()=>{const s=()=>{localStorage.removeItem("chatIds")};return()=>{s()}},[]),h.useEffect(()=>{const s=()=>{localStorage.removeItem("chatIds")};return window.addEventListener("beforeunload",s),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&s()}),()=>{window.removeEventListener("beforeunload",s),document.removeEventListener("visibilitychange",s)}},[]);const z=s=>{r(s),m([]),d(D=>D.map(_=>{if(_.roomId===s.roomId){const T={..._};c===_.buyerId&&(T.buyerUnreadCount=0),c===_.sellerId&&(T.sellerUnreadCount=0);const l=De.getInstance();if(l.socket){l.socket.emit("join_room",{userId:c,productId:s.productId,sellerId:s.sellerId,userType:s.userType,buyerId:s.buyerId});const N=s.userType==="buyer"?s.sellerId:s.buyerId;N&&l.getUserOnlineStatus(c,N)}return setTimeout(()=>{const N=s.roomId,t=Date.now(),y=J.current[N]||0;if(t-y<3e3)return;const u=c===s.buyerId;if(!(u?s.buyerUnreadCount:s.sellerUnreadCount))return;const M=()=>{const b=De.getInstance();if(b.socket){b.socket.emit("mark_as_read",{userId:c,roomId:N,productId:s.productId,sellerId:s.sellerId,buyerId:s.buyerId}),J.current[N]=Date.now(),d(v=>v.map(B=>B.roomId===N?{...B,buyerUnreadCount:u?0:B.buyerUnreadCount,sellerUnreadCount:u?B.sellerUnreadCount:0}:B));try{ie.getState().updateRecentChat({...s,buyerUnreadCount:u?0:s.buyerUnreadCount,sellerUnreadCount:u?s.sellerUnreadCount:0})}catch{}}};if(document.visibilityState==="visible"&&document.hasFocus())M();else{const b=()=>{document.visibilityState==="visible"&&document.hasFocus()&&(M(),window.removeEventListener("focus",b),document.removeEventListener("visibilitychange",b))};window.addEventListener("focus",b),document.addEventListener("visibilitychange",b)}},500),T}return _}))},ge=(s,D)=>{d(_=>{const T=_.findIndex(l=>l.roomId===s);if(T!==-1){const l=[..._];return l[T]=D(l[T]),setTimeout(()=>{try{ie.getState().setRecentChats(l)}catch{}},0),l}else{if(p&&p.roomId===s){console.log("Adding new chat to sidebar list:",s);const N=[D(p),..._];return setTimeout(()=>{try{ie.getState().setRecentChats(N)}catch{}},0),N}return _}})};return c?e.jsx("div",{className:"w-full max-w-7xl mx-auto px-4 mb-5",children:e.jsx("div",{className:"h-[calc(100vh-100px)] border-chat-border rounded-lg overflow-hidden mt-5",children:e.jsxs("div",{className:"flex h-full gap-2",children:[e.jsx("div",{className:"hidden md:block w-80 bg-gray-100 border-1 rounded-md",children:Y?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsx("p",{className:"text-muted-foreground",children:"Loading chats..."})}):e.jsx(lt,{onSelectContact:z,contacts:O,selectedContactId:p?.roomId||null,currentUserId:c})}),e.jsxs("div",{className:"flex-1 flex flex-col min-h-0",children:[e.jsx("div",{className:"md:hidden sm:p-4 py-2 border-chat-border bg-chat-sidebar",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h2",{className:"text-lg font-semibold text-foreground",children:"Messages"}),e.jsxs(jt,{open:I,onOpenChange:A,children:[e.jsx(Nt,{asChild:!0,children:e.jsx(fe,{variant:"ghost",size:"sm",children:e.jsx(wt,{className:"h-5 w-5"})})}),e.jsx(Ct,{side:"left",className:"p-0 w-80",children:e.jsx(lt,{onSelectContact:s=>{z(s),A(!1)},contacts:O,selectedContactId:p?.roomId||null,currentUserId:c})})]})]})}),p?e.jsx(Wt,{selectedContact:p,userType:k,userId:te,currentUserId:c,productId:p.productId,buyerId:p.buyerId,sellerId:p.sellerId,messages:U,setMessages:m,onSidebarContactUpdate:ge,setSelectedContact:r,isOnline:(()=>{const{isUserOnline:s}=ie.getState(),D=k==="buyer"?p.sellerId:p.buyerId;return s(D)})(),mergeQuoteMessage:L}):e.jsx("div",{className:"flex-1 flex items-center justify-center bg-background",children:e.jsxs("div",{className:"text-center text-muted-foreground",children:[e.jsx("h3",{className:"text-lg font-medium mb-2",children:Y?"Loading...":""}),e.jsx("p",{className:"text-sm",children:O.length===0?e.jsxs("div",{className:"flex justify-center items-center h-full flex-col space-y-2",children:[e.jsx("img",{src:"no-chat.webp",alt:"",className:"h-28 w-28"}),e.jsx("p",{className:"text-center text-lg capitalize",children:"No chats available"})]}):"Choose a contact from the sidebar to start messaging"})]})})]})]})})}):e.jsx("div",{className:"w-full max-w-7xl mx-auto px-4",children:e.jsx("div",{className:"h-screen flex items-center justify-center",children:e.jsx("div",{className:"text-center text-red-500 text-lg font-semibold",children:"Error: Please log in to access chat"})})})};export{es as default};
